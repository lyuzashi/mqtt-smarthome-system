# No password set for sudo
sudo apt update
sudo apt full-upgrade -y

# Install node (finding latest version for major in .nvmrc, using correct arch version)
SOURCE="https://nodejs.org/dist/latest"
MAJOR="$(sed -En 's/[^0-9]*([0-9]+).*/\1/p' .nvmrc)"
ARM="$(sed -n 's/model name.*(\(\S*\)).*$/\1/p' /proc/cpuinfo)"
NODE="$(curl -sL $SOURCE-v$MAJOR.x | grep arm$ARM.tar.xz | cut -d'"' -f2)"
wget -O node.tar.xz $SOURCE/$NODE
tar -xf node.tar.xz
chmod -R 755 node*/bin/*
sudo cp -r node*/{bin,lib,share} /usr/local
rm -r node*

# Install binary deps 
sudo apt install libasound2-dev alsa-base alsa-utils bluetooth libbluetooth-dev libudev-dev git libcap2-bin -y

# Provide BTL permissions to node binary
sudo setcap cap_net_raw+eip $(eval readlink -f `which node`)

# Setup user and global modules directory
USERNAME=hal
sudo useradd -m $USERNAME
NEWHOME=$(eval echo ~$USERNAME)
mkdir "${NEWHOME}/.npm-packages"
echo 'NPM_PACKAGES="${HOME}/.npm-packages"
NODE_PATH="$NPM_PACKAGES/lib/node_modules:$NODE_PATH"
PATH="$NPM_PACKAGES/bin:$PATH"
unset MANPATH
MANPATH="$NPM_PACKAGES/share/man:$(manpath)"
' | sudo tee -a $NEWHOME/.bashrc > /dev/null
echo 'prefix=${HOME}/.npm-packages' | sudo tee -a $NEWHOME/.npmrc > /dev/null
sudo chown hal:hal $NEWHOME/.npmrc


npm install -g forever

forever start -c "node --experimental-modules" main.mjs 

# Modules for node won't be available until reboot. Can they be installed though?
sudo rpi-update
reboot